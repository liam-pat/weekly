---
import '../styles/heti.min.css';
import HeadCommon from '../components/HeadCommon.astro';
import HeadSEO from '../components/HeadSEO.astro';
import Footer from '../components/Footer.astro';
import AstroLogo from '../components/Header/AstroLogo.astro';
import LeftSidebar from '../components/LeftSidebar.astro';
import Search from '../components/Header/Search.astro';
import { SITE, READING_SPEED, IMAGE_CONFIG } from '@/config';
import { parseTitle, sortPosts, getIndex, getPostId } from '@/util';

export interface Props {
  frontmatter: { date: string; pic: string; desc: string; url: string; headerTitle?: string };
  title: string;
}

const pageUrl = new URL(Astro.request.url);
const currentPage = pageUrl.pathname;

// Use the pre-calculated title from [id].astro if available, otherwise fallback
const { date, pic, desc, url, headerTitle } = Astro.props.frontmatter;

// The next article
const posts = await Astro.glob('../pages/posts/*.md');
const allPosts = sortPosts(posts);
const postIndex = getIndex(currentPage);

// Enhanced title logic: if headerTitle is missing, find it in allPosts
let title = headerTitle;
if (!title) {
  const currentPost = allPosts.find(p => getPostId(p) === postIndex);
  if (currentPost) {
    title = parseTitle(currentPost.file);
  } else {
    title = parseTitle(currentPage);
  }
}

// Calculate article statistics
// In Astro 5.x, slots can only be rendered once, so we store the result
const compiledContent = await Astro.slots.render('default');
const textContent = compiledContent.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

// Word count (for Chinese and English)
const chineseChars = textContent.match(/[\u4e00-\u9fa5]/g) || [];
const englishWords = textContent.match(/[a-zA-Z]+/g) || [];
const totalWords = chineseChars.length + englishWords.length;

// Reading time estimation
const readingTimeMinutes = Math.ceil(
  (chineseChars.length / READING_SPEED.chinese) + 
  (englishWords.length / READING_SPEED.english)
);
const readingTime = readingTimeMinutes < 1 ? '< 1' : readingTimeMinutes;

const content = {
  title,
  image: pic,
  description: desc,
};
const currentUrl = `${SITE.homePage}${currentPage}`;

const getPostUrl = (post) => {
  if (!post) return '';
  // Check if it's a legacy post with a URL or a raw file
  if (post.url) return post.url;
  return `/posts/${getPostId(post)}`;
}

let nextUrl = postIndex > 2 ? getPostUrl(allPosts[allPosts.length - postIndex + 1]) : '';
let prevUrl = postIndex < allPosts.length ? getPostUrl(allPosts[allPosts.length - postIndex - 1]) : '';
---

<html lang="zh-CN">
  <head>
    <HeadCommon />
    <HeadSEO content={content} pageURL={currentUrl} />
    <meta name="generator" content={Astro.generator} />
    <title>{SITE.title}{title}</title>
    <style>
      body {
        width: 100%;
        --gutter: 0.5rem;
        --doc-padding: 2rem;
      }

      .layout {
        display: grid;
        grid-auto-flow: column;
        grid-template-columns: minmax(var(--gutter), 1fr) minmax(0, var(--max-width)) minmax(var(--gutter), 1fr);
        overflow-x: hidden;
      }

      .heti h1.content-title:first-child {
        margin-block-start: 8px !important;
        margin-bottom: 16px;
        letter-spacing: 0.02em;
      }

      .grid-sidebar {
        height: 100vh;
        position: sticky;
        top: 0;
        padding: 0;
        margin-left: -5px;
      }

      #grid-left {
        position: fixed;
        background-color: var(--theme-bg);
        z-index: 10;
        display: none;
      }

      #grid-main {
        padding: 0.8rem var(--gutter) 4rem var(--gutter);
        grid-column: 2;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      #grid-right {
        display: none;
      }

      @media (min-width: 50em) {
        .layout {
          overflow: initial;
          grid-template-columns: 18rem minmax(0, var(--max-width));
          gap: 0;
        }

        #grid-main {
          padding: 0.8rem 2rem 4rem 2rem;
        }

        #grid-left {
          display: flex;
          padding-left: 2rem;
          position: sticky;
          grid-column: 1;
        }
      }

      @media (min-width: 72em) {
        .layout {
          grid-template-columns: 20rem minmax(0, var(--max-width)) 13rem;
          padding-left: 0;
          padding-right: 0;
          margin: 0 auto;
        }

        #grid-right {
          grid-column: 3;
          display: flex;
        }
      }

      .gsc-left-header .color-text-secondary {
        display: none;
      }

      .logo {
        display: none;
        margin-top: -0.1em;
      }

      @media (max-width: 50em) {
        .logo {
          display: block;
          color: #fff;
          margin-top: -0.1em;
          margin-right: 0.2em;
        }

        .logo:active {
          text-decoration: none;
          border-block-end: none;
          padding-block-end: unset;
        }

        #grid-main {
          margin-top: -7px;
          padding: 0.8rem 0.5rem var(--doc-padding) 0.5rem;
        }

        .heti h1.content-title:first-child {
          margin-bottom: 12px;
          font-size: 1.8rem;
        }
      }

      .post-footer a {
        color: var(--theme-accent);
      }

      .post-footer a:hover {
        border-block-end: none;
      }

      .heti .pay-button {
        color: var(--theme-bg);
        background-color: var(--theme-text);
        padding-block-end: 9px;
      }

      .heti .pay-button:hover {
        border-block-end: none;
        padding-block-end: 9px;
      }

      /* Reading Progress Bar */
      #reading-progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: linear-gradient(90deg, var(--theme-accent), var(--theme-accent-secondary, var(--theme-accent)));
        z-index: 9999;
        transition: width 0.1s ease-out;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- Reading Progress Bar -->
    <div id="reading-progress-bar"></div>
    <main class="layout">
      <aside id="grid-left" class="grid-sidebar" title="Site Navigation">
        <LeftSidebar currentPage={currentPage} />
      </aside>
      <div id="grid-main">
        <div
          class="markdown-body heti md:mx-auto md:pb-20 pb-14 xl:max-w-7xl w-full lg:max-w-5xl md:max-w-2xl md:pl-3.5"
          id="write"
        >
          <h1 class="content-title flex align-middle text-gray-800 dark:text-gray-200">
            <a class="logo inline-block md:hidden visible" href="/"><AstroLogo size={40} /> </a>
            <span data-pagefind-meta="title">{title}</span>
            <Search />
          </h1>
          
          <!-- Article Statistics -->
          <div class="article-stats flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-4 mt-2">
            <span class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              {totalWords.toLocaleString()} 字
            </span>
            <span class="flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              阅读时长 {readingTime} 分钟
            </span>
          </div>
          
          <Fragment set:html={compiledContent} />
          <div class="flex align-middle justify-center mt-4">
            <button
              class="inline-block items-center rounded px-5 py-3 text-sm font-medium pay-button cursor-pointer"
              type="button"
              title="功能开发中">去喂拉布拉多 ❤</button>
          </div>
          <hr />
          <div class="flex justify-between md:flex-row flex-col mt-2 post-footer">
            <div class="text-gray-800 dark:text-gray-200 flex-1">
              发布日期：<a
                href={`https://github.com/${SITE.repo}/tree/main/src/pages${url}.md`}
                target="_blank"
                data-pagefind-sort="date"
                title="Edit">{date}</a
              >
            </div>
            <div class="md:mt-0 mt-4 flex-1 text-right">
              {nextUrl ? <a href={nextUrl}>下一篇 |</a> : null}
              {prevUrl ? <a href={prevUrl}>上一篇 |</a> : null}
              <a href='/'>去首页 |</a>
              <a href='/rss.xml' title='Subscribe' target='_blank' class='xl:inline-block hidden'> RSS</a>
            </div>
          </div>
        </div>
        <script
          is:inline
          id="giscus-script"
          src="https://giscus.app/client.js"
          data-repo="liam-pat/weekly"
          data-repo-id="R_kgDOQpkB2g"
          data-category="General"
          data-category-id="DIC_kwDOQpkB2s4Cz3Gz"
          data-mapping="title"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="https://gw.alipayobjects.com/os/k/weekly/comment.css"
          data-lang="zh-CN"
          crossorigin="anonymous"
          async></script>
      </div>
    </main>
    <Footer />
    <script is:inline>
      window.addEventListener('DOMContentLoaded', () => {
        const images = document.querySelectorAll('#write img');
        images.forEach((img, index) => {
          if (index > IMAGE_CONFIG.lazyLoadThreshold) {
            img.setAttribute('loading', 'lazy');
            img.setAttribute('decoding', 'async');
          }
        });
      });
    </script>
    <script is:inline>
      // Reading Progress Bar
      window.addEventListener('DOMContentLoaded', () => {
        const progressBar = document.getElementById('reading-progress-bar');
        
        const updateProgressBar = () => {
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          
          // Calculate progress percentage
          const scrollableHeight = documentHeight - windowHeight;
          const scrollPercentage = (scrollTop / scrollableHeight) * 100;
          
          // Update progress bar width
          progressBar.style.width = Math.min(scrollPercentage, 100) + '%';
        };
        
        // Throttle function for better performance
        let ticking = false;
        const onScroll = () => {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              updateProgressBar();
              ticking = false;
            });
            ticking = true;
          }
        };
        
        // Initial update
        updateProgressBar();
        
        // Update on scroll
        window.addEventListener('scroll', onScroll, { passive: true });
      });
    </script>
  </body>
</html>
